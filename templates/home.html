<!DOCTYPE html>
<html>
    <head>
        <title>Light Loop Pi</title>
        <link rel="stylesheet" href="/static/css/bootstrap.min.css">
        <link rel="stylesheet" href="/static/css/bootstrap-theme.min.css">
        <link rel="stylesheet" href="/static/css/main.css"/>
        <script src="/static/js/jquery-2.1.1.min.js"></script>
        <script src="/static/js/underscore-min.js"></script>
        <script src="/static/js/bootstrap.min.js"></script>
        <script>
        function get_data() {
            $.get('/data', function(res) {
                alert(res);
            });
        };

        function save_data(data) {

            $('.light-channel').each(function(_, channel) {
                channel = $(channel);
                channel.find('.light-row').each(function(_, row) {
                    var vals = $(row).find('.light-cell-btn').map(function(x) { return $(x).hasClass('active') ? 1 : 0; });
                    console.log(_.values(vals));
                });
                console.log(channel.attr('data-light-channel'));
            });

            $.ajax({
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                dataType: 'json',
                url: '/data',
            });
        }

        $(document).ready(function() {
            var CHANNELS = 8;
            var SUB_CHANNELS = 8;
            var LOOP_LENGTH = 24;

            _.each(_.range(CHANNELS), function(i) {
                var row = $(_.template($('#light-row-template').text(), {i: i, subchannels: SUB_CHANNELS, cells: LOOP_LENGTH}));
                $('#light-container').append(row);
                $('#channel-btns').append($('<button type="button" class="btn btn-default channel-btn" data-channel="' + i + '">Channel ' + i + '</button>'));
            });

            $('.channel-btn').click(function() {
                var chan = $(this).attr('data-channel');
                $('.light-channel').hide();
                $('.light-channel[data-light-channel=' + chan +']').show();
            });

            $('#save-btn').click(function(){
                save_data();
            });
        });
        </script>
    </head>
    <body>
        <div class="container">
            <h1>Light Loop Pi</h1>
            <div class="btn-toolbar" role="toolbar">
                <div id="channel-btns" class="btn-group"></div>
                <div class="btn-group">
                    <button id="save-btn" type="button" class="btn btn-primary">Save</button>
                </div>
            </div>

            <div id="light-container"></div>
        </div>

        <script type="text/template" class="template" id="light-row-template">
            <div class="light-channel" data-light-channel="<%= i %>">
                <h3>Channel <%= i %></h3>
                <% _.each(_.range(subchannels), function(j) { %>
                    <div class="light-row" data-light-row="<%= j %>">
                        <span>Subchan <%= j %></span>
                        <% _.each(_.range(cells), function(k) { %>
                            <button type="button" class="btn btn-success light-cell-btn" data-toggle="button" data-light-cell="<%= k %>">&nbsp;</button>
                        <% }); %>
                    </div>
                <% }); %>
            </div>
        </script>
    </body>
</html>
