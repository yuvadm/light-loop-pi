<!DOCTYPE html>
<html>
    <head>
        <title>Light Loop Pi</title>
        <link rel="stylesheet" href="/static/css/bootstrap.min.css">
        <link rel="stylesheet" href="/static/css/bootstrap-theme.min.css">
        <link rel="stylesheet" href="/static/css/bootstrap-slider.css"/>
        <link rel="stylesheet" href="/static/css/main.css"/>
        <script src="/static/js/jquery-2.1.1.min.js"></script>
        <script src="/static/js/underscore-min.js"></script>
        <script src="/static/js/bootstrap.min.js"></script>
        <script src="/static/js/bootstrap-slider.min.js"></script>
        <script>
        function get_data() {
            $.get('/data', function(res) {
                alert(res);
            });
        };

        function save_data(data) {
            var data = {
                tempo: 500,
                trees: []
            };

            $('.light-tree').each(function(_idx, tree) {
                tree = $(tree);
                var tree_data = []
                tree.find('.light-row').each(function(_idx, row) {
                    var vals = $(row).find('.light-cell-btn').toArray().map(function(x) {
                        return x.className.contains('active') ? 1 : 0;
                    });
                    tree_data.push(vals);
                });
                data.trees.push(tree_data);
            });

            console.log('Saved:', data);

            $.ajax({
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                dataType: 'json',
                url: '/data',
            });
        }

        $(document).ready(function() {
            var TREES = 8;
            var CHANNELS = 8;
            var CELLS = 24;

            _.each(_.range(CHANNELS), function(i) {
                var row = $(_.template($('#light-row-template').text(), {i: i, channels: CHANNELS, cells: CELLS}));
                $('#light-container').append(row);
                $('#tree-btns').append($('<button type="button" class="btn btn-default tree-btn" data-tree="' + i + '">Tree ' + i + '</button>'));
            });

            $('#ex1').slider({
                formater: function(value) {
                    return 'Current value: ' + value;
                }
            });

            $('.tree-btn').click(function() {
                var tree = $(this).attr('data-tree');
                $('.light-tree').hide();
                $('.light-tree[data-light-tree=' + tree +']').show();
            });

            $('.toggle-row-btn').click(function() {
                var row = $(this).parent('.light-row');
                $(row).find('.light-cell-btn').toggleClass('active');
            })

            $('.clear-row-btn').click(function() {
                var row = $(this).parent('.light-row');
                $(row).find('.light-cell-btn').removeClass('active');
            })

            $('#save-btn').click(function(){
                save_data();
            });

            load_data();
        });
        </script>
    </head>
    <body>
        <div class="container">
            <h1>Light Loop Pi</h1>

            <div class="speed-slider">
                <label>Loop speed:</label>
                <input id="ex1" data-slider-id='ex1Slider' type="text" data-slider-min="500" data-slider-max="5000" data-slider-step="100" data-slider-value="1000"/>
            </div>

            <div class="btn-toolbar" role="toolbar">
                <div id="tree-btns" class="btn-group"></div>
                <div class="btn-group">
                    <button id="save-btn" type="button" class="btn btn-primary">Save</button>
                </div>
            </div>

            <div id="light-container"></div>
        </div>

        <script type="text/template" class="template" id="light-row-template">
            <div class="light-tree" data-light-tree="<%= i %>">
                <h3>Tree <%= i %></h3>
                <% _.each(_.range(channels), function(j) { %>
                    <div class="light-row" data-light-row="<%= j %>">
                        <span>Channel <%= j %></span>
                        <% _.each(_.range(cells), function(k) { %>
                            <button type="button" class="btn btn-success light-cell-btn" data-toggle="button" data-light-cell="<%= k %>">&nbsp;</button>
                        <% }); %>
                        <button type="button" class="btn btn-warning toggle-row-btn">Toggle</button>
                        <button type="button" class="btn btn-warning clear-row-btn">Clear</button>
                    </div>
                <% }); %>
            </div>
        </script>
    </body>
</html>
